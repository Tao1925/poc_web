# 数据库持久化完整解决方案

**文档时间**: 2025-10-25 21:52  
**状态**: ✅ 已测试通过  
**问题**: 数据库为空  
**解决**: 修正 MERGE 语句语法，添加列名

---

## 问题分析

### 问题1：数据库为空
**原因**: MERGE 语句缺少列名，导致SQL执行失败

**错误的写法**:
```sql
MERGE INTO users KEY(username) VALUES ('admin', '123456');
```

**正确的写法**:
```sql
MERGE INTO users (username, password) KEY(username) VALUES ('admin', '123456');
```

### 问题2：执行顺序
之前使用 `ddl-auto=none` + `schema.sql` 会导致执行顺序混乱。

## 最终解决方案

### 1. 配置文件 (application.properties)

```properties
spring.application.name=poc_web

# H2 file database (persistent) - 数据保存在本地文件
spring.datasource.url=jdbc:h2:file:./data/pocdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
spring.datasource.driverClassName=org.h2.Driver
spring.datasource.username=sa
spring.datasource.password=

# JPA & Hibernate - 自动管理表结构
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true

# SQL 初始化配置 - 只执行 data.sql
spring.sql.init.mode=always
spring.sql.init.data-locations=classpath:data.sql
spring.sql.init.continue-on-error=true
# 确保 SQL 在 Hibernate 初始化之后执行
spring.jpa.defer-datasource-initialization=true

# H2 console
spring.h2.console.enabled=true
spring.h2.console.path=/h2-console
```

### 2. 数据文件 (data.sql) - 正确的 MERGE 语法

```sql
-- 用户数据（必须指定列名）
MERGE INTO users (username, password) KEY(username) VALUES ('admin', '123456');
MERGE INTO users (username, password) KEY(username) VALUES ('student1', 'student123');
MERGE INTO users (username, password) KEY(username) VALUES ('teacher', 'teacher123');

-- 章节数据（必须指定列名）
MERGE INTO chapters (title, description, sort_order) KEY(sort_order) VALUES ('第一章：Java基础', '描述...', 1);
MERGE INTO chapters (title, description, sort_order) KEY(sort_order) VALUES ('第二章：面向对象编程', '描述...', 2);
MERGE INTO chapters (title, description, sort_order) KEY(sort_order) VALUES ('第三章：集合框架', '描述...', 3);
MERGE INTO chapters (title, description, sort_order) KEY(sort_order) VALUES ('第四章：异常处理', '描述...', 4);

-- 题目数据（必须指定列名）
MERGE INTO questions (title, description, question_number, sort_order, chapter_id) KEY(question_number) VALUES ('Java数据类型', '描述...', '1.1', 1, 1);
-- ... 其他题目
```

## 测试结果

### ✅ 测试1：数据加载
```bash
curl "http://localhost:8080/quiz/stats/student1"
# 结果：用户 student1 的答题统计：总共答题 0 道，有效答案 0 道
```

### ✅ 测试2：题目数据
```bash
curl "http://localhost:8080/quiz/question/1?username=student1"
# 结果：{"id":1,"title":"Java数据类型",...}
```

### ✅ 测试3：登录功能
```bash
curl -X POST "http://localhost:8080/login" -d "username=student1&password=student123"
# 结果：重定向到 quiz 页面
```

### ✅ 测试4：答题保存
```bash
curl -X POST "http://localhost:8080/quiz/save" -d "questionId=1&content=<p>测试答案</p>&username=student1"
# 结果：答案保存成功

curl "http://localhost:8080/quiz/answer/1?username=student1"
# 结果：包含 "测试答案"
```

### ✅ 测试5：数据持久化
```bash
# 1. 重启应用
# 2. 查询数据
curl "http://localhost:8080/quiz/stats/student1"
# 结果：用户 student1 的答题统计：总共答题 1 道，有效答案 1 道

curl "http://localhost:8080/quiz/answer/1?username=student1"
# 结果：测试答案内容仍然存在
```

## 核心要点

### 1. MERGE 语句必须指定列名
```sql
-- ❌ 错误
MERGE INTO users KEY(username) VALUES ('admin', '123456');

-- ✅ 正确
MERGE INTO users (username, password) KEY(username) VALUES ('admin', '123456');
```

### 2. 使用 Hibernate 管理表结构
```properties
# 让 Hibernate 自动创建/更新表
spring.jpa.hibernate.ddl-auto=update
```

### 3. 只使用 data.sql
```properties
# 只加载数据，不加载 schema.sql
spring.sql.init.data-locations=classpath:data.sql
```

### 4. 延迟初始化
```properties
# SQL 在 Hibernate 之后执行
spring.jpa.defer-datasource-initialization=true
```

## 工作流程

```
1. Spring Boot 启动
   ↓
2. Hibernate 初始化
   - 读取实体类（User, Chapter, Question, Answer）
   - 自动创建表结构
   ↓
3. 执行 data.sql
   - MERGE 插入用户数据（3条）
   - MERGE 插入章节数据（4条）
   - MERGE 插入题目数据（12条）
   ↓
4. 应用就绪
```

## 数据存储

- **位置**: `./data/pocdb.mv.db`
- **类型**: H2 文件数据库
- **大小**: 约 32KB（初始数据）
- **持久化**: ✅ 是

## 使用方法

### 首次启动或重置
```bash
rm -rf ./data
mvn spring-boot:run
```

### 正常启动
```bash
mvn spring-boot:run
```

### 访问应用
- 首页: http://localhost:8080/
- H2控制台: http://localhost:8080/h2-console
  - JDBC URL: `jdbc:h2:file:./data/pocdb`
  - 用户名: `sa`，密码: (留空)

### 测试账号
- `admin` / `123456`
- `student1` / `student123`
- `teacher` / `teacher123`

## 优势总结

### ✅ 数据持久化
- 应用重启后数据不丢失
- 答题记录永久保存
- 数据保存在本地文件

### ✅ 自动去重
- MERGE 语句避免重复
- 多次启动不会产生重复数据
- 基于唯一键自动处理

### ✅ 易于维护
- Hibernate 自动管理表结构
- 不需要维护 schema.sql
- 实体类变更自动更新表

### ✅ 简单可靠
- 一条命令启动
- 自动初始化数据
- 配置清晰明了

## 备份与恢复

### 备份
```bash
cp -r ./data ./data_backup_$(date +%Y%m%d)
```

### 恢复
```bash
rm -rf ./data
cp -r ./data_backup_20251025 ./data
```

### 重置
```bash
rm -rf ./data
mvn spring-boot:run
```

## 故障排除

### 问题：数据仍然为空

**解决步骤**:
```bash
# 1. 停止应用
pkill -f spring-boot

# 2. 删除数据库
rm -rf ./data

# 3. 检查 data.sql 语法
# 确认 MERGE 语句包含列名

# 4. 重新启动
mvn spring-boot:run

# 5. 验证数据
curl "http://localhost:8080/quiz/stats/student1"
```

## MERGE 语句参考

### 用户表
```sql
MERGE INTO users (username, password) KEY(username) VALUES ('admin', '123456');
```

### 章节表
```sql
MERGE INTO chapters (title, description, sort_order) KEY(sort_order) VALUES ('第一章', '描述', 1);
```

### 题目表
```sql
MERGE INTO questions (title, description, question_number, sort_order, chapter_id) KEY(question_number) VALUES ('标题', '描述', '1.1', 1, 1);
```

## 测试验证清单

- [x] 应用正常启动
- [x] 用户数据加载成功（3条）
- [x] 章节数据加载成功（4条）
- [x] 题目数据加载成功（12条）
- [x] 登录功能正常
- [x] 答题保存功能正常
- [x] 答题数据可查询
- [x] 数据持久化保存
- [x] 重启后数据不丢失
- [x] 重启后答题记录保留
- [x] 多次启动不会数据重复

## 总结

通过以下修改，成功实现了数据库持久化：

1. ✅ **修正 MERGE 语法**：添加列名 `(column1, column2)`
2. ✅ **使用 Hibernate**：自动管理表结构
3. ✅ **只用 data.sql**：移除 schema.sql
4. ✅ **延迟初始化**：确保执行顺序正确

**所有功能已测试通过，可以正常使用！**

---

**文档位置**: `ai_process_md/数据库持久化完整解决方案_20251025_2152.md`  
**遵守规则**: prompt.md 第 22-24 行（一次对话一个文档，包含时间）
