# 后台判题系统开发

**文档时间**: 2025-10-26 11:23  
**状态**: ✅ 开发完成并测试通过  
**功能**: admin 用户后台判题界面  
**需求来源**: prompt.md 第 29-35 行

---

## 需求分析

根据 prompt.md 的要求，需要实现以下功能：

### 核心需求

1. **页面布局**
   - 左侧：与答题界面相同的目录结构（章节+题目）
   - 右侧上部：题目内容展示
   - 右侧下部：所有学生的答题内容（可滚动）

2. **答题展示**
   - 显示用户姓名
   - 显示得分输入框
   - 显示总分（只读文本）
   - 显示用户答题内容

3. **数据库修改**
   - ANSWERS 表增加 `score` 字段（用户得分）
   - QUESTIONS 表增加 `total_score` 字段（题目总分）

4. **登录逻辑**
   - admin 用户登录后跳转到判题界面
   - 普通用户登录后跳转到答题界面

---

## 实施方案

### 1. 数据库表结构修改

#### ANSWERS 表增加字段

```java
@Column(name = "score")
private Double score;  // 该用户这道题得的分数
```

#### QUESTIONS 表增加字段

```java
@Column(name = "total_score")
private Double totalScore;  // 这道题的总分
```

#### 初始数据更新

在 `data.sql` 中为每道题目设置总分：

```sql
-- 题目数据（增加 total_score 字段）
MERGE INTO questions (title, description, question_number, sort_order, total_score, chapter_id) 
KEY(question_number) VALUES ('Java数据类型', '...', '1.1', 1, 10.0, 1);
MERGE INTO questions (title, description, question_number, sort_order, total_score, chapter_id) 
KEY(question_number) VALUES ('控制结构', '...', '1.2', 2, 15.0, 1);
-- ... 其他题目
```

**总分设置**：
- 第一章：10分、15分、20分
- 第二章：15分、20分、25分
- 第三章：15分、20分、15分
- 第四章：10分、15分、20分

---

### 2. 后端开发

#### 2.1 实体类更新

**Answer.java** - 增加 score 字段及 getter/setter

**Question.java** - 增加 totalScore 字段及 getter/setter

#### 2.2 Repository 扩展

**AnswerRepository.java** - 增加方法：

```java
List<Answer> findByQuestion(Question question);
```

用于获取某个题目的所有学生答案。

#### 2.3 GradingController 创建

新建 `GradingController.java`，提供以下接口：

| 接口 | 方法 | 功能 |
|------|------|------|
| `/grading` | GET | 判题页面 |
| `/grading/question/{questionId}/answers` | GET | 获取题目的所有学生答案 |
| `/grading/updateScore` | POST | 更新答案分数 |

**核心逻辑**：

```java
@GetMapping("/grading/question/{questionId}/answers")
@ResponseBody
public ResponseEntity<List<Map<String, Object>>> getQuestionAnswers(@PathVariable Long questionId) {
    // 1. 查询题目
    // 2. 查询该题目的所有答案
    // 3. 过滤掉 admin 用户的答案
    // 4. 返回答案列表（包含用户名、内容、得分、总分等）
}

@PostMapping("/grading/updateScore")
@ResponseBody
public ResponseEntity<String> updateScore(@RequestParam Long answerId, 
                                         @RequestParam Double score) {
    // 1. 查询答案
    // 2. 验证分数不超过总分
    // 3. 更新分数
    // 4. 保存到数据库
}
```

#### 2.4 登录逻辑修改

**LoginController.java** - 修改登录成功后的跳转逻辑：

```java
if (password.equals(user.getPassword())) {
    if ("admin".equals(username)) {
        // admin用户跳转到判题界面
        return "redirect:/grading?username=" + username;
    } else {
        // 普通用户跳转到答题界面
        return "redirect:/quiz?username=" + username;
    }
}
```

---

### 3. 前端开发

#### 3.1 grading.html 页面结构

基于 `quiz.html` 的布局，创建 `grading.html`：

```html
<div class="grading-container">
    <!-- 左侧目录（15%） -->
    <div class="sidebar">
        <h3>📋 判题目录</h3>
        <!-- 章节和题目列表 -->
    </div>
    
    <!-- 右侧内容（85%） -->
    <div class="main-content">
        <!-- 题目说明区域（20%） -->
        <div class="question-section">
            <!-- 题目标题和描述 -->
        </div>
        
        <!-- 学生答案区域（80%） -->
        <div class="answers-section">
            <div class="section-title">👥 学生答案</div>
            <div id="answers-container">
                <!-- 动态加载学生答案卡片 -->
            </div>
        </div>
    </div>
</div>
```

#### 3.2 答案卡片设计

每个学生答案显示为一个卡片：

```html
<div class="answer-card">
    <div class="answer-header">
        <span class="student-name">👤 student1</span>
        <div class="score-input-group">
            <label>得分：</label>
            <input type="number" class="score-input" value="8.5" max="10.0">
            <span class="total-score">/ 10.0 分</span>
            <button class="save-score-btn">保存</button>
        </div>
    </div>
    <div class="answer-content">
        <!-- 学生的答题内容（支持HTML富文本和图片） -->
    </div>
    <div class="answer-meta">
        提交时间: 2025-10-26 10:30 | 更新时间: 2025-10-26 11:00
    </div>
</div>
```

#### 3.3 JavaScript 功能

**核心函数**：

1. `selectQuestion(element)` - 选择题目
2. `loadQuestion(questionId)` - 加载题目内容
3. `loadAnswers(questionId)` - 加载学生答案列表
4. `saveScore(answerId, totalScore)` - 保存评分

**评分逻辑**：

```javascript
function saveScore(answerId, totalScore) {
    const scoreInput = document.getElementById(`score-${answerId}`);
    const score = parseFloat(scoreInput.value);
    
    // 验证分数
    if (isNaN(score) || score < 0) {
        showStatus('error', '请输入有效的分数');
        return;
    }
    
    if (score > totalScore) {
        showStatus('error', `得分不能超过总分 ${totalScore}`);
        return;
    }
    
    // 提交到后端
    fetch('/grading/updateScore', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(result => {
        showStatus('success', result);
    });
}
```

#### 3.4 样式设计

**特色样式**：
- 主题色：红色系（#e74c3c）区别于答题界面的蓝色
- 卡片式布局：每个学生答案独立卡片
- 可滚动区域：答案区域支持鼠标滚轮滚动
- 响应式输入：评分输入框带验证

---

## 测试验证

### 测试数据生成

创建 `generate_test_data.sh` 脚本，自动生成测试数据：

**生成的数据**：
- student1：3道题的答案（题目1, 2, 4）
- teacher：4道题的答案（题目1, 2, 3, 4）

**数据特点**：
- 包含HTML格式的富文本
- 包含代码块（使用 `<pre>` 标签）
- 包含列表和标题

### 功能测试

创建 `test_grading_system.sh` 脚本，自动化测试所有功能：

#### 测试项目

| 测试项 | 测试内容 | 结果 |
|--------|---------|------|
| 1 | 应用状态检查 | ✅ 通过 |
| 2 | admin用户登录跳转 | ✅ 通过 |
| 3 | 普通用户登录跳转 | ✅ 通过 |
| 4 | 获取题目答案列表 | ✅ 通过 |
| 5 | 评分功能 | ✅ 通过 |
| 6 | 评分验证（超过总分） | ✅ 通过 |
| 7 | 判题界面HTML渲染 | ✅ 通过 |
| 8 | 测试数据统计 | ✅ 通过 |

#### 测试结果

```
=========================================
✅ 测试完成
=========================================

测试结果总结：
  ✓ admin用户登录跳转到判题界面
  ✓ 普通用户登录跳转到答题界面
  ✓ 可以获取题目的所有学生答案
  ✓ 评分功能正常工作
  ✓ 评分验证（超过总分）正常
  ✓ 判题界面HTML正确渲染
```

---

## 功能特性

### ✅ 页面布局

- **左侧目录（15%）**：章节折叠展开，题目列表
- **右侧上部（20%）**：题目标题和描述
- **右侧下部（80%）**：学生答案列表，可滚动

### ✅ 答案展示

每个学生答案卡片包含：
- 👤 用户姓名
- 📝 得分输入框（数字类型，带最大值限制）
- 📊 总分显示（只读）
- 💾 保存按钮
- 📄 答题内容（支持富文本和图片）
- ⏰ 提交和更新时间

### ✅ 评分功能

- 输入验证：不能为负数，不能超过总分
- 实时保存：点击保存按钮立即提交
- 状态反馈：成功/失败消息提示
- 数据持久化：保存到数据库

### ✅ 用户体验

- 红色主题：与答题界面（蓝色）区分
- 卡片式设计：清晰的视觉层次
- 滚动支持：答案过多时可滚动查看
- 即时反馈：操作结果实时显示

---

## 文件清单

### 新增文件

| 文件 | 类型 | 说明 |
|------|------|------|
| `GradingController.java` | Controller | 判题接口控制器 |
| `grading.html` | 前端页面 | 判题界面 |
| `generate_test_data.sh` | 测试脚本 | 生成测试数据 |
| `test_grading_system.sh` | 测试脚本 | 功能自动化测试 |

### 修改文件

| 文件 | 修改内容 |
|------|---------|
| `Answer.java` | 增加 score 字段 |
| `Question.java` | 增加 totalScore 字段 |
| `AnswerRepository.java` | 增加 findByQuestion 方法 |
| `LoginController.java` | 修改登录跳转逻辑 |
| `data.sql` | 为题目添加 total_score 数据 |

---

## 使用指南

### 管理员操作流程

```
1. 访问 http://localhost:8080/
   ↓
2. 使用 admin/123456 登录
   ↓
3. 自动跳转到判题界面 (/grading)
   ↓
4. 点击左侧题目
   ↓
5. 查看右侧学生答案列表
   ↓
6. 为每个学生输入得分
   ↓
7. 点击"保存"按钮
   ↓
8. 系统提示"评分成功"
```

### 学生操作流程

```
1. 访问 http://localhost:8080/
   ↓
2. 使用 student1/student123 登录
   ↓
3. 自动跳转到答题界面 (/quiz)
   ↓
4. 正常答题
```

---

## 技术实现细节

### 1. 数据过滤

在获取答案时，过滤掉 admin 用户的答案：

```java
List<Map<String, Object>> result = answers.stream()
    .filter(answer -> !"admin".equals(answer.getUser().getUsername()))
    .filter(answer -> answer.getContent() != null && !answer.getContent().trim().isEmpty())
    .map(answer -> {
        // 转换为 Map
    })
    .collect(Collectors.toList());
```

### 2. 分数验证

后端验证分数不能超过总分：

```java
Double totalScore = answer.getQuestion().getTotalScore();
if (totalScore != null && score > totalScore) {
    return ResponseEntity.badRequest().body("得分不能超过总分: " + totalScore);
}
```

### 3. 动态渲染

前端使用模板字符串动态生成答案卡片：

```javascript
container.innerHTML = answers.map(answer => `
    <div class="answer-card">
        <div class="answer-header">
            <span class="student-name">👤 ${answer.username}</span>
            <div class="score-input-group">
                <input type="number" 
                       id="score-${answer.answerId}"
                       value="${answer.score || ''}" 
                       max="${answer.totalScore}">
                <span class="total-score">/ ${answer.totalScore} 分</span>
                <button onclick="saveScore(${answer.answerId}, ${answer.totalScore})">
                    保存
                </button>
            </div>
        </div>
        <div class="answer-content">${answer.content}</div>
    </div>
`).join('');
```

### 4. 富文本支持

答案内容支持 HTML 富文本，包括：
- 标题（`<h3>`）
- 段落（`<p>`）
- 列表（`<ul>`, `<ol>`, `<li>`）
- 代码块（`<pre>`）
- 图片（`<img>`）

---

## 数据库设计

### ANSWERS 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| content | TEXT | 答案内容 |
| **score** | DOUBLE | **得分（新增）** |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |
| question_id | BIGINT | 题目ID（外键） |
| user_id | BIGINT | 用户ID（外键） |

### QUESTIONS 表结构

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 主键 |
| title | VARCHAR(300) | 题目标题 |
| description | VARCHAR(2000) | 题目描述 |
| question_number | VARCHAR(20) | 题号 |
| sort_order | INT | 排序 |
| **total_score** | DOUBLE | **总分（新增）** |
| chapter_id | BIGINT | 章节ID（外键） |

---

## API 接口文档

### 1. 获取判题页面

**接口**: `GET /grading`

**参数**:
- `username`: 用户名（必须为 admin）

**返回**: HTML 页面

**权限**: 仅 admin 用户

---

### 2. 获取题目的所有学生答案

**接口**: `GET /grading/question/{questionId}/answers`

**参数**:
- `questionId`: 题目ID（路径参数）

**返回**: JSON 数组

```json
[
    {
        "answerId": 1,
        "username": "student1",
        "content": "<div>答案内容...</div>",
        "score": 8.5,
        "totalScore": 10.0,
        "createdAt": "2025-10-26T10:30:00",
        "updatedAt": "2025-10-26T11:00:00"
    }
]
```

**说明**:
- 自动过滤 admin 用户的答案
- 只返回有内容的答案

---

### 3. 更新答案分数

**接口**: `POST /grading/updateScore`

**参数**:
- `answerId`: 答案ID
- `score`: 得分

**返回**: 文本消息

**成功**: `"评分成功"`

**失败**: `"得分不能超过总分: 10.0"` 或 `"答案不存在"`

**验证规则**:
- 分数必须 ≥ 0
- 分数不能超过题目总分

---

## 测试脚本使用

### 生成测试数据

```bash
./ai_script/generate_test_data.sh
```

**功能**:
- 为 student1 生成 3 道题的答案
- 为 teacher 生成 4 道题的答案
- 答案包含富文本和代码块

### 功能测试

```bash
./ai_script/test_grading_system.sh
```

**测试内容**:
- admin 用户登录跳转
- 普通用户登录跳转
- 获取答案列表
- 评分功能
- 评分验证
- 页面渲染

---

## 注意事项

### 1. 数据库重建

由于修改了表结构，需要重建数据库：

```bash
pkill -f spring-boot
rm -rf ./data
mvn spring-boot:run
```

### 2. 权限控制

当前实现的权限控制较简单：
- 仅通过用户名判断是否为 admin
- 实际项目中应使用角色（Role）机制

### 3. 评分精度

使用 `Double` 类型存储分数，支持小数（如 8.5 分）

### 4. 并发问题

当前未处理并发评分的情况，多个管理员同时评分可能产生覆盖

---

## 优化建议

### 未来可优化项

1. **批量评分**
   - 一次性为多个学生评分
   - 提高评分效率

2. **评分历史**
   - 记录评分修改历史
   - 支持评分审计

3. **评分统计**
   - 显示平均分、最高分、最低分
   - 生成成绩分布图表

4. **评语功能**
   - 为每个答案添加评语
   - 支持富文本评语

5. **导出功能**
   - 导出成绩单（Excel）
   - 导出答案内容（PDF）

6. **权限细化**
   - 使用 Spring Security
   - 基于角色的访问控制（RBAC）

7. **实时通知**
   - 评分后通知学生
   - WebSocket 实时推送

---

## 故障排除

### 问题1：admin登录后仍跳转到答题界面

**原因**: 代码未正确部署或缓存问题

**解决**:
```bash
mvn clean compile
pkill -f spring-boot
mvn spring-boot:run
```

### 问题2：获取答案列表为空

**原因**: 没有生成测试数据

**解决**:
```bash
./ai_script/generate_test_data.sh
```

### 问题3：评分保存失败

**原因**: 分数超过总分或答案不存在

**解决**: 检查输入的分数是否合法

### 问题4：页面显示异常

**原因**: 浏览器缓存

**解决**: 清除浏览器缓存或使用隐私模式

---

## 总结

### 完成的功能

✅ **数据库表结构**
- ANSWERS 表增加 score 字段
- QUESTIONS 表增加 total_score 字段
- 初始数据包含总分信息

✅ **后端接口**
- 判题页面路由
- 获取学生答案列表
- 更新答案分数
- 分数验证逻辑

✅ **前端界面**
- 判题页面布局（类似答题界面）
- 学生答案卡片展示
- 评分输入和保存
- 实时状态反馈

✅ **登录逻辑**
- admin 用户跳转到判题界面
- 普通用户跳转到答题界面

✅ **测试验证**
- 自动生成测试数据
- 功能自动化测试
- 所有测试项通过

### 技术亮点

1. **用户体验优化**
   - 卡片式设计，清晰直观
   - 红色主题区别于答题界面
   - 可滚动区域，支持大量答案

2. **数据验证**
   - 前后端双重验证
   - 防止无效评分

3. **富文本支持**
   - 完整保留学生答案格式
   - 支持图片显示

4. **自动化测试**
   - 一键生成测试数据
   - 全面的功能测试覆盖

---

**文档位置**: `ai_process_md/后台判题系统开发_20251026_1123.md`  
**测试脚本**: 
- `ai_script/generate_test_data.sh` - 生成测试数据
- `ai_script/test_grading_system.sh` - 功能测试

**遵守规则**: 每轮问答生成新文档，包含时间戳（YYYYMMDD_HHMM）

