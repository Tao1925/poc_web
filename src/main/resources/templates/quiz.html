<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­”é¢˜ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .quiz-container {
            display: flex;
            height: 100vh;
        }
        
        /* å·¦ä¾§ç›®å½•åŒºåŸŸ */
        .sidebar {
            width: 15%;
            background-color: #2c3e50;
            color: white;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar h3 {
            padding: 0 20px 15px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 15px;
            color: #ecf0f1;
        }
        
        .chapter {
            margin-bottom: 10px;
        }
        
        .chapter-title {
            padding: 10px 20px;
            background-color: #34495e;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .chapter-title:hover {
            background-color: #4a5f7a;
        }
        
        .chapter-title.active {
            background-color: #3498db;
        }
        
        .questions-list {
            display: none;
            background-color: #34495e;
        }
        
        .questions-list.show {
            display: block;
        }
        
        .question-item {
            padding: 8px 20px 8px 40px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 3px solid transparent;
        }
        
        .question-item:hover {
            background-color: #4a5f7a;
        }
        
        .question-item.active {
            background-color: #3498db;
            border-left-color: #ecf0f1;
        }
        
        .question-item.answered {
            color: #2ecc71;
        }
        
        /* å³ä¾§å†…å®¹åŒºåŸŸ */
        .main-content {
            width: 85%;
            display: flex;
            flex-direction: column;
        }
        
        /* é¢˜ç›®è¯´æ˜åŒºåŸŸ */
        .question-section {
            height: 20%;
            background-color: white;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            overflow-y: auto;
        }
        
        .question-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .question-description {
            color: #555;
            line-height: 1.6;
            font-size: 1.1em;
        }
        
        .no-question {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            margin-top: 50px;
        }
        
        /* ç­”é¢˜åŒºåŸŸ */
        .answer-section {
            height: 80%;
            background-color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .answer-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .answer-editor {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            background-color: #fafafa;
            transition: border-color 0.3s;
        }
        
        .answer-editor:focus {
            border-color: #3498db;
            background-color: white;
        }
        
        .save-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .save-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .save-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .save-status.saving {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* å·¥å…·æ  */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toolbar button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toolbar button:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }
        
        .toolbar button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .sidebar {
                width: 25%;
            }
            
            .main-content {
                width: 75%;
            }
            
            .question-section {
                height: 25%;
            }
            
            .answer-section {
                height: 75%;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- å·¦ä¾§ç›®å½• -->
        <div class="sidebar">
            <h3>ğŸ“š é¢˜ç›®ç›®å½•</h3>
            <div th:each="chapter : ${chapters}" class="chapter">
                <div class="chapter-title" th:onclick="toggleChapter(this)" th:text="${chapter.title}">
                    ç« èŠ‚æ ‡é¢˜
                </div>
                <div class="questions-list" th:id="'questions-' + ${chapter.id}">
                    <div th:each="question : ${chapter.questions}" 
                         class="question-item" 
                         th:data-question-id="${question.id}"
                         th:onclick="selectQuestion(this)"
                         th:text="${question.questionNumber + '. ' + question.title}">
                        é¢˜ç›®
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- é¢˜ç›®è¯´æ˜åŒºåŸŸ -->
            <div class="question-section">
                <div id="question-content">
                    <div class="no-question">
                        è¯·ä»å·¦ä¾§é€‰æ‹©é¢˜ç›®å¼€å§‹ç­”é¢˜
                    </div>
                </div>
            </div>
            
            <!-- ç­”é¢˜åŒºåŸŸ -->
            <div class="answer-section">
                <div class="answer-title">ğŸ’­ æˆ‘çš„ç­”æ¡ˆ</div>
                
                <div class="toolbar">
                    <button onclick="formatText('bold')" title="ç²—ä½“">B</button>
                    <button onclick="formatText('italic')" title="æ–œä½“">I</button>
                    <button onclick="formatText('underline')" title="ä¸‹åˆ’çº¿">U</button>
                    <button onclick="insertImage()" title="æ’å…¥å›¾ç‰‡">ğŸ“·</button>
                    <button onclick="clearFormat()" title="æ¸…é™¤æ ¼å¼">æ¸…é™¤æ ¼å¼</button>
                </div>
                
                <div id="answer-editor" 
                     class="answer-editor" 
                     contenteditable="true" 
                     data-placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„ç­”æ¡ˆ...">
                </div>
                
                <div id="save-status" class="save-status"></div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestionId = null;
        let currentUsername = '[[${username}]]';
        let saveTimeout = null;
        
        // åˆ‡æ¢ç« èŠ‚æ˜¾ç¤º
        function toggleChapter(element) {
            const chapterId = element.nextElementSibling.id.split('-')[1];
            const questionsList = document.getElementById('questions-' + chapterId);
            
            // åˆ‡æ¢æ˜¾ç¤ºçŠ¶æ€
            questionsList.classList.toggle('show');
            
            // æ›´æ–°ç« èŠ‚æ ‡é¢˜æ ·å¼
            document.querySelectorAll('.chapter-title').forEach(title => {
                title.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        // é€‰æ‹©é¢˜ç›®
        function selectQuestion(element) {
            const questionId = element.dataset.questionId;
            
            // æ›´æ–°é¢˜ç›®é¡¹æ ·å¼
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // åŠ è½½é¢˜ç›®å†…å®¹
            loadQuestion(questionId);
            
            // åŠ è½½ç”¨æˆ·ç­”æ¡ˆ
            loadAnswer(questionId);
        }
        
        // åŠ è½½é¢˜ç›®å†…å®¹
        function loadQuestion(questionId) {
            currentQuestionId = questionId;
            
            fetch(`/quiz/question/${questionId}?username=${currentUsername}`)
                .then(response => response.json())
                .then(question => {
                    const questionContent = document.getElementById('question-content');
                    questionContent.innerHTML = `
                        <div class="question-title">${question.questionNumber}. ${question.title}</div>
                        <div class="question-description">${question.description}</div>
                    `;
                })
                .catch(error => {
                    console.error('åŠ è½½é¢˜ç›®å¤±è´¥:', error);
                });
        }
        
        // åŠ è½½ç”¨æˆ·ç­”æ¡ˆ
        function loadAnswer(questionId) {
            fetch(`/quiz/answer/${questionId}?username=${currentUsername}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(answer => {
                    const editor = document.getElementById('answer-editor');
                    
                    // æ£€æŸ¥ç­”æ¡ˆå†…å®¹æ˜¯å¦å­˜åœ¨ä¸”ä¸ä¸ºç©º
                    if (answer.content && answer.content.trim()) {
                        editor.innerHTML = answer.content;
                        console.log(`åŠ è½½é¢˜ç›® ${questionId} çš„ç­”æ¡ˆæˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${answer.content.length}`);
                    } else {
                        editor.innerHTML = '';
                        console.log(`é¢˜ç›® ${questionId} æš‚æ— ç­”æ¡ˆ`);
                    }
                    
                    // æ ‡è®°è¯¥é¢˜ç›®å·²ç­”é¢˜çŠ¶æ€
                    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
                    if (answer.content && answer.content.trim()) {
                        questionItem.classList.add('answered');
                    } else {
                        questionItem.classList.remove('answered');
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½ç­”æ¡ˆå¤±è´¥:', error);
                    showSaveStatus('error', 'åŠ è½½ç­”æ¡ˆå¤±è´¥: ' + error.message);
                });
        }
        
        // è‡ªåŠ¨ä¿å­˜åŠŸèƒ½
        document.getElementById('answer-editor').addEventListener('input', function() {
            if (currentQuestionId) {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
                showSaveStatus('saving', 'æ­£åœ¨ä¿å­˜...');
                
                // è®¾ç½®æ–°çš„å®šæ—¶å™¨
                saveTimeout = setTimeout(() => {
                    saveAnswer();
                }, 2000); // 2ç§’åè‡ªåŠ¨ä¿å­˜
            }
        });
        
        // ä¿å­˜ç­”æ¡ˆ
        function saveAnswer() {
            if (!currentQuestionId) {
                console.warn('æ²¡æœ‰é€‰æ‹©é¢˜ç›®ï¼Œæ— æ³•ä¿å­˜ç­”æ¡ˆ');
                return;
            }
            
            const content = document.getElementById('answer-editor').innerHTML;
            
            // æ£€æŸ¥å†…å®¹æ˜¯å¦ä¸ºç©º
            if (!content || content.trim() === '' || content === '<br>' || content === '<div><br></div>') {
                console.log('ç­”æ¡ˆå†…å®¹ä¸ºç©ºï¼Œè·³è¿‡ä¿å­˜');
                return;
            }
            
            const formData = new FormData();
            formData.append('questionId', currentQuestionId);
            formData.append('content', content);
            formData.append('username', currentUsername);
            
            console.log(`æ­£åœ¨ä¿å­˜é¢˜ç›® ${currentQuestionId} çš„ç­”æ¡ˆï¼Œå†…å®¹é•¿åº¦: ${content.length}`);
            
            fetch('/quiz/save', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(result => {
                console.log('ä¿å­˜ç»“æœ:', result);
                if (result.includes('æˆåŠŸ')) {
                    showSaveStatus('success', result);
                    
                    // æ ‡è®°è¯¥é¢˜ç›®å·²ç­”é¢˜
                    const questionItem = document.querySelector(`[data-question-id="${currentQuestionId}"]`);
                    questionItem.classList.add('answered');
                } else {
                    showSaveStatus('error', 'ä¿å­˜å¤±è´¥: ' + result);
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å¤±è´¥:', error);
                showSaveStatus('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            });
        }
        
        // æ˜¾ç¤ºä¿å­˜çŠ¶æ€
        function showSaveStatus(type, message) {
            const statusElement = document.getElementById('save-status');
            statusElement.className = `save-status ${type}`;
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // 3ç§’åéšè—çŠ¶æ€
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        // æ ¼å¼åŒ–æ–‡æœ¬
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('answer-editor').focus();
        }
        
        // æ’å…¥å›¾ç‰‡
        function insertImage() {
            const url = prompt('è¯·è¾“å…¥å›¾ç‰‡URL:');
            if (url) {
                document.execCommand('insertImage', false, url);
                document.getElementById('answer-editor').focus();
            }
        }
        
        // æ¸…é™¤æ ¼å¼
        function clearFormat() {
            document.execCommand('removeFormat', false, null);
            document.getElementById('answer-editor').focus();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®ç¼–è¾‘å™¨å ä½ç¬¦
            const editor = document.getElementById('answer-editor');
            editor.addEventListener('focus', function() {
                if (this.innerHTML === '') {
                    this.innerHTML = '';
                }
            });
            
            editor.addEventListener('blur', function() {
                if (this.innerHTML === '') {
                    this.innerHTML = '';
                }
            });
            
            // åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
            loadUserStats();
        });
        
        // åŠ è½½ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯
        function loadUserStats() {
            fetch(`/quiz/stats/${currentUsername}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(stats => {
                    console.log('ç”¨æˆ·ç»Ÿè®¡ä¿¡æ¯:', stats);
                    // å¯ä»¥åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
                    showSaveStatus('success', stats);
                })
                .catch(error => {
                    console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                });
        }
    </script>
</body>
</html>
