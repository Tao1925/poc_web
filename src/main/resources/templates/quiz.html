<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Á≠îÈ¢òÁ≥ªÁªü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background-color: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }
        
        .quiz-container {
            display: flex;
            height: 100vh;
        }
        
        /* Â∑¶‰æßÁõÆÂΩïÂå∫Âüü */
        .sidebar {
            width: 15%;
            background-color: #2c3e50;
            color: white;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .sidebar h3 {
            padding: 0 20px 15px;
            border-bottom: 1px solid #34495e;
            margin-bottom: 15px;
            color: #ecf0f1;
        }
        
        .chapter {
            margin-bottom: 10px;
        }
        
        .chapter-title {
            padding: 10px 20px;
            background-color: #34495e;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .chapter-title:hover {
            background-color: #4a5f7a;
        }
        
        .chapter-title.active {
            background-color: #3498db;
        }
        
        .questions-list {
            display: none;
            background-color: #34495e;
        }
        
        .questions-list.show {
            display: block;
        }
        
        .question-item {
            padding: 8px 20px 8px 40px;
            cursor: pointer;
            transition: background-color 0.3s;
            border-left: 3px solid transparent;
        }
        
        .question-item:hover {
            background-color: #4a5f7a;
        }
        
        .question-item.active {
            background-color: #3498db;
            border-left-color: #ecf0f1;
        }
        
        .question-item.answered {
            color: #2ecc71;
        }
        
        /* Âè≥‰æßÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            width: 85%;
            display: flex;
            flex-direction: column;
        }
        
        /* È¢òÁõÆËØ¥ÊòéÂå∫Âüü */
        .question-section {
            height: 20%;
            background-color: white;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            overflow-y: auto;
        }
        
        .question-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .question-description {
            color: #555;
            line-height: 1.6;
            font-size: 1.1em;
        }
        
        .no-question {
            text-align: center;
            color: #999;
            font-size: 1.2em;
            margin-top: 50px;
        }
        
        /* Á≠îÈ¢òÂå∫Âüü */
        .answer-section {
            height: 80%;
            background-color: white;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .answer-title {
            font-size: 1.3em;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .answer-editor {
            flex: 1;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            outline: none;
            overflow-y: auto;
            background-color: #fafafa;
            transition: border-color 0.3s;
        }
        
        .answer-editor:focus {
            border-color: #3498db;
            background-color: white;
        }
        
        .save-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            display: none;
        }
        
        .save-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .save-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .save-status.saving {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* Â∑•ÂÖ∑Ê†è */
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .toolbar button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .toolbar button:hover {
            background-color: #f8f9fa;
            border-color: #3498db;
        }
        
        .toolbar button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .sidebar {
                width: 25%;
            }
            
            .main-content {
                width: 75%;
            }
            
            .question-section {
                height: 25%;
            }
            
            .answer-section {
                height: 75%;
            }
        }
    </style>
</head>
<body>
    <div class="quiz-container">
        <!-- Â∑¶‰æßÁõÆÂΩï -->
        <div class="sidebar">
            <h3>üìö È¢òÁõÆÁõÆÂΩï</h3>
            <div th:each="chapter : ${chapters}" class="chapter">
                <div class="chapter-title" th:onclick="toggleChapter(this)" th:text="${chapter.title}">
                    Á´†ËäÇÊ†áÈ¢ò
                </div>
                <div class="questions-list" th:id="'questions-' + ${chapter.id}">
                    <div th:each="question : ${chapter.questions}" 
                         class="question-item" 
                         th:data-question-id="${question.id}"
                         th:onclick="selectQuestion(this)"
                         th:text="${question.questionNumber + '. ' + question.title}">
                        È¢òÁõÆ
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Âè≥‰æßÂÜÖÂÆπÂå∫Âüü -->
        <div class="main-content">
            <!-- È¢òÁõÆËØ¥ÊòéÂå∫Âüü -->
            <div class="question-section">
                <div id="question-content">
                    <div class="no-question">
                        ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©È¢òÁõÆÂºÄÂßãÁ≠îÈ¢ò
                    </div>
                </div>
            </div>
            
            <!-- Á≠îÈ¢òÂå∫Âüü -->
            <div class="answer-section">
                <div class="answer-title">üí≠ ÊàëÁöÑÁ≠îÊ°à</div>
                
                <div class="toolbar">
                    <button onclick="formatText('bold')" title="Á≤ó‰Ωì">B</button>
                    <button onclick="formatText('italic')" title="Êñú‰Ωì">I</button>
                    <button onclick="formatText('underline')" title="‰∏ãÂàíÁ∫ø">U</button>
                    <button onclick="insertImage()" title="ÊèíÂÖ•ÂõæÁâá">üì∑</button>
                    <button onclick="clearFormat()" title="Ê∏ÖÈô§Ê†ºÂºè">Ê∏ÖÈô§Ê†ºÂºè</button>
                </div>
                
                <div id="answer-editor" 
                     class="answer-editor" 
                     contenteditable="true" 
                     data-placeholder="ËØ∑Âú®Ê≠§ËæìÂÖ•ÊÇ®ÁöÑÁ≠îÊ°à...">
                </div>
                
                <div id="save-status" class="save-status"></div>
            </div>
        </div>
    </div>

    <script>
        let currentQuestionId = null;
        let currentUsername = '[[${username}]]';
        let saveTimeout = null;
        
        // ÂàáÊç¢Á´†ËäÇÊòæÁ§∫
        function toggleChapter(element) {
            const chapterId = element.nextElementSibling.id.split('-')[1];
            const questionsList = document.getElementById('questions-' + chapterId);
            
            // ÂàáÊç¢ÊòæÁ§∫Áä∂ÊÄÅ
            questionsList.classList.toggle('show');
            
            // Êõ¥Êñ∞Á´†ËäÇÊ†áÈ¢òÊ†∑Âºè
            document.querySelectorAll('.chapter-title').forEach(title => {
                title.classList.remove('active');
            });
            element.classList.add('active');
        }
        
        // ÈÄâÊã©È¢òÁõÆ
        function selectQuestion(element) {
            const questionId = element.dataset.questionId;
            
            // Êõ¥Êñ∞È¢òÁõÆÈ°πÊ†∑Âºè
            document.querySelectorAll('.question-item').forEach(item => {
                item.classList.remove('active');
            });
            element.classList.add('active');
            
            // Âä†ËΩΩÈ¢òÁõÆÂÜÖÂÆπ
            loadQuestion(questionId);
            
            // Âä†ËΩΩÁî®Êà∑Á≠îÊ°à
            loadAnswer(questionId);
        }
        
        // Âä†ËΩΩÈ¢òÁõÆÂÜÖÂÆπ
        function loadQuestion(questionId) {
            currentQuestionId = questionId;
            
            fetch(`/quiz/question/${questionId}?username=${currentUsername}`)
                .then(response => response.json())
                .then(question => {
                    const questionContent = document.getElementById('question-content');
                    questionContent.innerHTML = `
                        <div class="question-title">${question.questionNumber}. ${question.title}</div>
                        <div class="question-description">${question.description}</div>
                    `;
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÈ¢òÁõÆÂ§±Ë¥•:', error);
                });
        }
        
        // Âä†ËΩΩÁî®Êà∑Á≠îÊ°à
        function loadAnswer(questionId) {
            fetch(`/quiz/answer/${questionId}?username=${currentUsername}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(answer => {
                    const editor = document.getElementById('answer-editor');
                    
                    // Ê£ÄÊü•Á≠îÊ°àÂÜÖÂÆπÊòØÂê¶Â≠òÂú®‰∏î‰∏ç‰∏∫Á©∫
                    if (answer.content && answer.content.trim()) {
                        editor.innerHTML = answer.content;
                        console.log(`Âä†ËΩΩÈ¢òÁõÆ ${questionId} ÁöÑÁ≠îÊ°àÊàêÂäüÔºåÂÜÖÂÆπÈïøÂ∫¶: ${answer.content.length}`);
                    } else {
                        editor.innerHTML = '';
                        console.log(`È¢òÁõÆ ${questionId} ÊöÇÊó†Á≠îÊ°à`);
                    }
                    
                    // Ê†áËÆ∞ËØ•È¢òÁõÆÂ∑≤Á≠îÈ¢òÁä∂ÊÄÅ
                    const questionItem = document.querySelector(`[data-question-id="${questionId}"]`);
                    if (answer.content && answer.content.trim()) {
                        questionItem.classList.add('answered');
                    } else {
                        questionItem.classList.remove('answered');
                    }
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁ≠îÊ°àÂ§±Ë¥•:', error);
                    showSaveStatus('error', 'Âä†ËΩΩÁ≠îÊ°àÂ§±Ë¥•: ' + error.message);
                });
        }
        
        // Ëá™Âä®‰øùÂ≠òÂäüËÉΩ
        document.getElementById('answer-editor').addEventListener('input', function() {
            if (currentQuestionId) {
                // Ê∏ÖÈô§‰πãÂâçÁöÑÂÆöÊó∂Âô®
                if (saveTimeout) {
                    clearTimeout(saveTimeout);
                }
                
                // ÊòæÁ§∫‰øùÂ≠òÁä∂ÊÄÅ
                showSaveStatus('saving', 'Ê≠£Âú®‰øùÂ≠ò...');
                
                // ËÆæÁΩÆÊñ∞ÁöÑÂÆöÊó∂Âô®
                saveTimeout = setTimeout(() => {
                    saveAnswer();
                }, 2000); // 2ÁßíÂêéËá™Âä®‰øùÂ≠ò
            }
        });
        
        // ‰øùÂ≠òÁ≠îÊ°à
        function saveAnswer() {
            if (!currentQuestionId) {
                console.warn('Ê≤°ÊúâÈÄâÊã©È¢òÁõÆÔºåÊó†Ê≥ï‰øùÂ≠òÁ≠îÊ°à');
                return;
            }
            
            const content = document.getElementById('answer-editor').innerHTML;
            
            // Ê£ÄÊü•ÂÜÖÂÆπÊòØÂê¶‰∏∫Á©∫
            if (!content || content.trim() === '' || content === '<br>' || content === '<div><br></div>') {
                console.log('Á≠îÊ°àÂÜÖÂÆπ‰∏∫Á©∫ÔºåË∑≥Ëøá‰øùÂ≠ò');
                return;
            }
            
            const formData = new FormData();
            formData.append('questionId', currentQuestionId);
            formData.append('content', content);
            formData.append('username', currentUsername);
            
            console.log(`Ê≠£Âú®‰øùÂ≠òÈ¢òÁõÆ ${currentQuestionId} ÁöÑÁ≠îÊ°àÔºåÂÜÖÂÆπÈïøÂ∫¶: ${content.length}`);
            
            fetch('/quiz/save', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(result => {
                console.log('‰øùÂ≠òÁªìÊûú:', result);
                if (result.includes('ÊàêÂäü')) {
                    showSaveStatus('success', result);
                    
                    // Ê†áËÆ∞ËØ•È¢òÁõÆÂ∑≤Á≠îÈ¢ò
                    const questionItem = document.querySelector(`[data-question-id="${currentQuestionId}"]`);
                    questionItem.classList.add('answered');
                } else {
                    showSaveStatus('error', '‰øùÂ≠òÂ§±Ë¥•: ' + result);
                }
            })
            .catch(error => {
                console.error('‰øùÂ≠òÂ§±Ë¥•:', error);
                showSaveStatus('error', '‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            });
        }
        
        // ÊòæÁ§∫‰øùÂ≠òÁä∂ÊÄÅ
        function showSaveStatus(type, message) {
            const statusElement = document.getElementById('save-status');
            statusElement.className = `save-status ${type}`;
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            // 3ÁßíÂêéÈöêËóèÁä∂ÊÄÅ
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        // Ê†ºÂºèÂåñÊñáÊú¨
        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('answer-editor').focus();
        }
        
        // ÊèíÂÖ•ÂõæÁâá
        function insertImage() {
            const url = prompt('ËØ∑ËæìÂÖ•ÂõæÁâáURL:');
            if (url) {
                document.execCommand('insertImage', false, url);
                document.getElementById('answer-editor').focus();
            }
        }
        
        // Ê∏ÖÈô§Ê†ºÂºè
        function clearFormat() {
            document.execCommand('removeFormat', false, null);
            document.getElementById('answer-editor').focus();
        }
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            // ËÆæÁΩÆÁºñËæëÂô®Âç†‰ΩçÁ¨¶
            const editor = document.getElementById('answer-editor');
            editor.addEventListener('focus', function() {
                if (this.innerHTML === '') {
                    this.innerHTML = '';
                }
            });
            
            editor.addEventListener('blur', function() {
                if (this.innerHTML === '') {
                    this.innerHTML = '';
                }
            });
            
            // Âä†ËΩΩÁî®Êà∑ÁªüËÆ°‰ø°ÊÅØ
            loadUserStats();
        });
        
        // Âä†ËΩΩÁî®Êà∑ÁªüËÆ°‰ø°ÊÅØ
        function loadUserStats() {
            fetch(`/quiz/stats/${currentUsername}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(stats => {
                    console.log('Áî®Êà∑ÁªüËÆ°‰ø°ÊÅØ:', stats);
                    // ÂèØ‰ª•Âú®È°µÈù¢‰∏äÊòæÁ§∫ÁªüËÆ°‰ø°ÊÅØ
                    showSaveStatus('success', stats);
                })
                .catch(error => {
                    console.error('Âä†ËΩΩÁªüËÆ°‰ø°ÊÅØÂ§±Ë¥•:', error);
                });
        }
    </script>
</body>
</html>
